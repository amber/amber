<!doctype html>
<meta charset=utf-8>
<title>UI Demo</title>

<link rel=stylesheet href=static/demo.css>
<link rel=icon href=static/favicon.png>
<body>
<script src=markup.js></script>
<script src=src.js></script>
<script src=locale/en-US.js></script>

<script>

var a = Amber;

a.model('DemoUser', {

  data: {
    name: {},
    handle: {},
    about: {}
  }
});

a.view('Demo', {

  template: 'demo-template',

  render: function(model) {
    ['name', 'handle', 'about'].forEach(function(key) {
      this[key] = a.view.DemoEditor(model, { key: key });
    }, this);
  }
});

a.view('DemoListItem', {

  template: '<li>{{name}}</li>',

  render: function(model) {
    this.name = a.view.Key(model, 'name');
  }
});

a.view('DemoEditor', {

  focus: function() {
    this.el.focus();
  },


  template: '<span class="editable" tabindex="0"></span>',

  events: {
    'input el': function() {
      this.model[this.key] = this.el.textContent;
    },
    'focus el': function() {
      this.el.style.WebkitUserModify = 'read-write-plaintext-only';

      var sel = window.getSelection();
      sel.removeAllRanges();
      var range = document.createRange();
      range.selectNodeContents(this.el);
      sel.addRange(range);
    },
    'blur el': function() {
      this.el.style.WebkitUserModify = 'read-only';
    }
  },

  render: function(model) {
    model.on(this.key + 'Changed', this.contentChanged.bind(this));

    this.contentChanged();
  },

  contentChanged: function() {
    var value = this.model[this.key];
    if (this.el.textContent !== value) {
      this.el.textContent = value;
    }
  }
});

function addUser(model) {
  a.view.DemoListItem(model).use(function(view) {
    list.appendChild(view.el);
  });
  return a.view.Demo(model).use(function(view) {
    document.body.insertBefore(view.el, template);
  });
}

var list = document.createElement('ul');
document.body.appendChild(list);

var template = document.createElement('button');
template.className = 'template';
template.addEventListener('click', function() {
  addUser(a.model.DemoUser({
    name: "Name",
    handle: "handle",
    about: "About me..."
  })).use(function(view) {
    view.name.focus();
  });
});
document.body.appendChild(template);

[
  a.model.DemoUser({
    name: "Nathan Dinsmore",
    handle: "nathan",
    about: "Nathan writes the Amber client."
  }),
  a.model.DemoUser({
    name: "Truman Kilen",
    handle: "MathWizz",
    about: "Truman writes the Amber server and puts up with Nathan."
  }),
  a.model.DemoUser({
    name: "Amber",
    handle: "amber",
    about: "The Github organization for Amber and related projects."
  })
].forEach(addUser);

</script>

